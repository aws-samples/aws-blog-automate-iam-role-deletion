Proactively detecting and responding to unused IAM roles will help you prevent unauthorized entities to leverage it to get access to your AWS resources. You can build automation to enforce this process and periodically check IAM resources then take actions to delete unused IAM roles in an AWS Account. This blog post gives an example solution of how you can leverage Tags and AWS Serverless technologies to create such an automation. Follow blog post “How to centralize findings and automate deletion for unused IAM role” for more details.


## **Solution architecture**

![Architecture Diagram](/images/checkUnusedIAMRoleSolution.png)

The architecture diagram above demonstrate the automation workflow. There are two option to run this solution: in a single AWS Account belongs to an organization/OU, or in every member accounts belong to an organization or an organization unit.

## Walkthrough: Deploy the solution

### Prerequisites

* You will need to have an AWS Organization organization or a Security account .
* The solution should be deployed only in a central Security account, in which has appropriate admin permission to audit other accounts, and manage security automation.
* Since this solution will create CloudFormation StackSet in member accounts of organization/OU that you specify, the Security account will need to have a [Cloudformation delegated admin permission](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-orgs-delegated-admin.html) to create AWS resources in this solution. If you run this solution for a single account, you need to [establish trust relationship](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html)between the Security account and target account by creating  AWSCloudFormationStackSetAdministrationRole IAM Role in Security account and  AWSCloudFormationStackSetExecutionRole in target account.
* This solution uses AWS Security Hub as a central dashboard in Security account that aggregates findings. Security Hub needs to be enable in Security Account. AWS Security Hub provides [predefined response and remediation actions](https://aws.amazon.com/solutions/implementations/aws-security-hub-automated-response-and-remediation/) based on industry compliance standards and best practices for security threats. It currently doesn’t have automation to check for unused IAM Roles. However, this solution can show you how to create custom findings and import to Security Hub.  The solution needs to be deploy in the home region that you use Security Hub dashboard.
* There should be an existing tagging enforcement already applied to IAM Roles. This solution use tag to identify owner email address. 
* This solution use Amazon SES to send email to IAM Role’s Owner. The sender address will need to be [verified with Amazon SES](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/verify-email-addresses.html). If your account is still in the Amazon SES sandbox, you also need to verify any email addresses that you send emails to.


### Deploy the solution using AWS CLI

Alternatively, you can run these AWS CLI command to deploy the solution. Start with cloning the git repo. 

```
git clone https://github.com/aws-samples/aws-blog-automate-iam-role-deletion 
cd /aws-blog-automate-iam-role-deletion
```

Run [Cloudformation package](https://docs.aws.amazon.com/cli/latest/reference/cloudformation/package.html)to upload templates and Lambda code to your S3 bucket. The S3 bucket needs to be in the same region that you will deploy this solution

```
#Deploy solution for a single target AWS Account
aws cloudformation package \
--template-file solution_scope_account.yml \
--s3-bucket YOUR_BUCKET_NAME \
--s3-prefix PATH_TO_UPLOAD_CODE \
--output-template-file solution_scope_account.template
```

```
#Deploy solution for an Organization/OU
aws cloudformation package \
--template-file solution_scope_organization.yml \
--s3-bucket YOUR_BUCKET_NAME \
--s3-prefix PATH_TO_UPLOAD_CODE \
--output-template-file solution_scope_organization.template
```


Validate if the template generated by Cloudformation package is valid

```
#Deploy solution for a single target AWS Account
aws cloudformation validate-template —template-body file://solution_scope_account.template
```

```
#Deploy solution for an Organization/OU
aws cloudformation validate-template —template-body file://solution_scope_organization.template
```

Deploy the solution in the same region with Security Hub home region. The stack takes 30 minutes to complete deployment

```
#Deploy solution for a single target AWS Account
aws cloudformation deploy \
--template-file solution_scope_account.template \
--stack-name UNIQUE_STACK_NAME \
--region REGION \
--capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
--parameter-overrides AccountId='TARGET ACCOUNT ID' \
Frequency=[days] MaxDaysForLastUsed=[days] \
ITSecurityEmail='YOUR IT TEAM EMAIL' \
RolePatternAllowedlist='ALLOWED PATTERN'
```

```
#Deploy solution for an Organization
aws cloudformation deploy \
--template-file solution_scope_organization.template \
--stack-name UNIQUE_STACK_NAME \
--region REGION \
--capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
--parameter-overrides Scope=Organization \
OrganizationId='o-12345abcde' \
OrgRootId='r-1234'  \
Frequency=[days] MaxDaysForLastUsed=[days] \
ITSecurityEmail='security-team@example.com' \
RolePatternAllowedlist='ALLOWED PATTERN'
```

```
#Deploy solution for an OU
aws cloudformation deploy \
--template-file solution_scope_organization.template \
--stack-name UNIQUE_STACK_NAME \
--region REGION \
--capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
--parameter-overrides Scope=OrganizationalUnit \
OrganizationId='o-12345abcde' \
OrganizationalUnitId='ou-1234-1234abcd'  \
Frequency=[days] MaxDaysForLastUsed=[days] \
ITSecurityEmail='security-team@example.com' \
RolePatternAllowedlist='ALLOWED PATTERN'
```



## Next step
Here are a few suggestions that you can take to extend this solution.

•	This solution uses a private API Gateway to handle the approval response from the IAM role owner. You need to establish private connectivity between your internal network and AWS to invoke a private API Gateway. For instructions, see How to invoke a private API.
•	Add a mechanism to control access to API Gateway by using endpoint policies for interface VPC endpoints.
•	Archive the Security Hub finding after the IAM role is deleted using the AWS CLI or AWS Console.
•	Use a Step Functions state machine for other automation that needs human approval.
•	Add the capability to report on IAM roles that were skipped due to the absence of RoleLastUsed information.

